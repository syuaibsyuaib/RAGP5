# RAGP5 - Task Reformat Fundamental
**Tanggal:** 2026-02-24  
**Status:** DONE

---

## Latar Belakang

Format CTN berbasis teks memiliki keterbatasan:
- Node tanpa sinapsis tidak representatif.
- Update sinapsis mahal (rewrite).
- Parsing lambat.
- Tidak ada pemisahan jelas memori stabil vs memori baru.

Migrasi dilakukan ke binary storage: `base.bin + delta.bin`.

---

## Checklist

### Rust (`src/lib.rs`)
- [x] Tambah crate `lru` dan `crc32fast` ke Cargo.toml
- [x] Tambah crate `sysinfo` untuk budget cache adaptif
- [x] Struct engine binary (`RagpEngine`)
- [x] Header `base.bin` (magic, version, node_count)
- [x] Node index + synapse data
- [x] Header `delta.bin`
- [x] Delta entry (sender, receiver, weight, timestamp, checksum CRC32)
- [x] `delta_index` RAM (latest-per-pair)
- [x] Hybrid cache `pinned + LRU`
- [x] `node_index` RAM
- [x] `init_node_pool()` 109 node
- [x] Hebbian `form_synapses_from_window()` weight awal 0.01
- [x] `get_connections()` merge base cache + delta overlay
- [x] `update_weight()` via delta + validasi node
- [x] `compute_cd()` dari binary source
- [x] `consolidate()` merge delta -> base + pruning + cache refresh
- [x] Startup resume `base + delta` melalui `load_delta_index()`

### Python (`main.py`, `ragp_loop.py`)
- [x] Hapus jalur runtime CTN lama
- [x] Inisialisasi `RagpEngine`
- [x] Init node pool 109 hanya saat first-init
- [x] Runtime utama melalui `ragp_loop.py`
- [x] `ragp_loop.py` selaras API Rust (`int` IDs, spread activation, Hebbian form)
- [x] Default startup resume (`base + delta`)
- [x] Reset hanya eksplisit (`--reset` atau `RAGP_RESET_STORAGE=1`)

### File lama
- [x] `ctn_storage/*.ctn` tidak dipakai runtime utama
- [x] Survival loop lama di `main.py` dihapus

---

## Perubahan Penting

1. **Persistensi default**
- Startup melanjutkan state `base.bin + delta.bin`.
- `delta.bin` tetap dikosongkan setelah `consolidate()`.

2. **Cache policy baru**
- `pinned + LRU` dengan budget RAM adaptif.
- Env yang didukung:
  - `RAGP_CACHE_POLICY` (default `pinned_lru`)
  - `RAGP_CACHE_RAM_FRACTION` (default `0.25`)
  - `RAGP_CACHE_RAM_MIN_MB` (default `256`)
  - `RAGP_CACHE_RAM_MAX_MB` (default `1536`)
  - `RAGP_CACHE_PIN_FRACTION` (default `0.35`)

3. **Base storage chunking**
- `base.bin` sekarang dipakai sebagai manifest index.
- Synapse data disimpan per range sender:
  - `base_000001_000100.bin`
  - `base_000101_000200.bin`
  - dst.
- Migrasi otomatis dari format `base.bin` monolith ke chunk saat startup.

3. **Observability**
- `status()` menampilkan:
  - `pinned_nodes`
  - `lru_nodes`
  - `cache_budget_mb`
  - `cache_bytes_est_mb`

---

## Progress Log

- [x] Arsitektur final disetujui
- [x] `Cargo.toml` diupdate
- [x] `lib.rs` ditulis ulang dan align dengan runtime target
- [x] `main.py` ditulis ulang sebagai orchestrator
- [x] `ragp_loop.py` disesuaikan dengan API engine
- [x] Verifikasi build + run end-to-end
